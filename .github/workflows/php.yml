name: Build and Publish

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: v${{ steps.get-current-version.outputs.group1 }}
      release: ${{ steps.get-release-version.outputs.release }}
    name: Build
    steps:
    - uses: actions/checkout@v4

    - name: "Read file contents"
      id: read_file
      uses: satya-500/read-file-github-action@v1.0.0
      with:
        path: "TaskOrganiser/composer.json"

    - uses: actions-ecosystem/action-regex-match@v2.0.2
      name: Get Current Version
      id: get-current-version
      with:
        text: ${{ steps.read_file.outputs.contents }}
        regex: '"version": "([^"]*)'
        flags: gm

    - name: Get Release version
      id: get-release-version
      uses: pozetroninc/github-action-get-latest-release@master
      with:
        repository: ${{ github.repository }}

  createRelease:
    needs: build
    runs-on: ubuntu-latest
    name: Build and Create Release
    if: ${{needs.build.outputs.version != needs.build.outputs.release}}
    
    steps:
    - uses: actions/checkout@v4

    - name: Move relevant files
      run: |
        cp README.md ./TaskOrganiser/README.md
        cp LICENSE ./TaskOrganiser/LICENSE

    - name: Zip Release Code
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r release.zip TaskOrganiser

    - name: Create Tag
      uses: jaywcjlove/create-tag-action@main
      with:
        version: "${{needs.build.outputs.version}}"

    - name: Generate Release
      uses: ncipollo/release-action@v1
      with:
        skipIfReleaseExists: true
        artifacts: "release.zip"
        tag: "${{needs.build.outputs.version}}"
        generateReleaseNotes: true
